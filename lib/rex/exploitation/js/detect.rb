# -*- coding: binary -*-

require 'msf/core'
require 'rex/text'
require 'rex/exploitation/jsobfu'

module Rex
module Exploitation
module Js


class Detect

  #
  # Provides several javascript functions for determining the OS and browser versions of a client.
  #
  # getVersion():  returns an object with the following properties
  # os_name      -  OS name such as "Windows 8", "Linux", "Mac OS X"
  # os_flavor    -  OS flavor as a string such as "Home", "Enterprise", etc
  # os_sp        -  OS service pack (e.g.: "SP2", will be empty on non-Windows)
  # os_lang      -  OS language (e.g.: "en-us")
  # os_vendor    -  A company or organization name such as Microsoft, Ubuntu, Apple, etc
  # os_device    -  A specific piece of hardware such as iPad, iPhone, etc
  # ua_name      -  Client name, one of the Msf::HttpClients constants
  # ua_version   -  Client version as a string (e.g.: "3.5.1", "6.0;SP2")
  # arch         -  Architecture, one of the ARCH_* constants
  #
  # The following functions work on the version returned in obj.ua_version
  #
  # ua_ver_cmp(a, b): returns -1, 0, or 1 based on whether a < b, a == b, or a > b respectively
  # ua_ver_lt(a, b):  returns true if a < b
  # ua_ver_gt(a, b):  returns true if a > b
  # ua_ver_eq(a, b):  returns true if a == b
  #
  def self.os(custom_js = '')
    js  = custom_js
    js << ::File.read(::File.join(Msf::Config.data_directory, "js", "detect", "os.js"))

    Rex::Exploitation::JSObfu.new(js)
  end


  #
  # Provides javascript functions to determine IE addon information.
  #
  # getMsOfficeVersion(): Returns the version for Microsoft Office
  #
  def self.ie_addons(custom_js = '')
    js  = custom_js
    js << ::File.read(::File.join(Msf::Config.data_directory, "js", "detect", "ie_addons.js"))

    Rex::Exploitation::JSObfu.new(js)
  end

  #
  # Provides javascript functions that work for all browsers to determine addon information
  #
  # getJavaVersion(): Returns the Java version
  # hasSilverlight(): Returns whether Silverlight is enabled or not
  #
  def self.misc_addons(custom_js = '')
    js  = custom_js
    js << ::File.read(::File.join(Msf::Config.data_directory, "js", "detect", "misc_addons.js"))

    Rex::Exploitation::JSObfu.new(js)
  end

  #
  # Provides several javascript functions for extracting browser information.
  #
  # basicInfo():    returns an object with properties like the following:
  # nav_appCodeName: Mozilla
  # nav_appName: Netscape
  # nav_appVersion: 5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.81 Safari/537.36
  # nav_cookieEnabled: true
  # nav_doNotTrack: 1
  # nav_hardwareConcurrency: 8
  # nav_language: en-US
  # nav_languages: en-US,en
  # nav_platform: Win32
  # nav_product: Gecko
  # nav_productSub: 20030107
  # nav_userAgent: Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.81 Safari/537.36
  # nav_vendor: Google Inc.
  # time_time: 1436767914498
  # time_offset: 300
  # nav_battery_charging: true
  # nav_battery_dischargingTime: Infinity
  # nav_battery_level: 1
  # screen_height: 1200
  # screen_width: 1920
  # screen_colorDepth: 24
  # screen_pixelDepth: 24
  # screen_availHeight: 1160
  # screen_availWidth: 1920
  # screen_availLeft: -1920
  # plugins_0_name: Shockwave Flash
  # plugins_0_filename: pepflashplayer.dll
  # plugins_0_version: undefined
  # plugins_0_description: Shockwave Flash 18.0 r0
  # webgl_vendor: WebKit
  # webgl_renderer: WebKit WebGL
  # webgl_version: WebGL 1.0 (OpenGL ES 2.0 Chromium)
  # webgl_shading_language_version: WebGL GLSL ES 1.0 (OpenGL ES GLSL ES 1.0 Chromium)
  # webgl_unmasked_renderer: ANGLE (NVIDIA GeForce GTX TITAN Direct3D11 vs_5_0 ps_5_0)
  # webgl_unmasked_vendor: Google Inc.
  # ie_version_major: 11
  # ie_version_minor: 0
  # ie_version_build: 17840
  #
  def self.info(custom_js = '')
    js  = custom_js
    js << ::File.read(::File.join(Msf::Config.data_directory, "js", "detect", "info.js"))

    Rex::Exploitation::JSObfu.new(js)
  end

end
end
end
end
